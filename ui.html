<!doctype html>
<html>
  <head>
    <title>Pictionary</title>
  </head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <link rel="stylesheet" href="/css/ui.css" type="text/css" />
<script>
  $(function () {
    var socket = io();
    window.onload = function(){
      var name = window.prompt("Please enter your name", "guest")
      $('#chatnick').val(name)
      socket.emit('get name', name)
      socket.emit('set canvas')
    }
    $("#m").on('keyup', function (e) {
      if (e.keyCode == 13) {
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
      }
    });
    socket.on('clear the board', function(){
      $('#wordbox').html("")
      //socket.emit('clearCanvas');
    })
    socket.on('special message', function(msg){
      $('#chatcontent').append($('<p>').css('color', 'red').text(msg));
      $('#chatcontent').scrollTop($('#chatcontent')[0].scrollHeight);
    });
    socket.on('chat message', function(msg){
      $('#chatcontent').append($('<p>').text(msg));
      $('#chatcontent').scrollTop($('#chatcontent')[0].scrollHeight);
    });
    socket.on('user connect', function(name, key){
      var e = $('<div></div>').text(name)
      $('#users').append(e);
      e.attr('id', key);
    })
    socket.on('user disconnect', function(index){
      $('#' + index).remove();
    })
    socket.on('do host stuff', function(){
      console.log("it worked")
      var choice = window.prompt("You have guessed the word first, or are the only person on right now. Pick a word.", "apple")
      socket.emit('my turn now')
      $('#wordbox').html(choice)
      socket.emit('send word to server',choice)
    })
    //canvas stuff
    var canvas = $('#canvas'),
		  selectedcolor = $('.color'),
		  context = canvas[0].getContext('2d'),
		  lastpoint = null,
		  status = false,
		  myturn = true;
	    socket.on('draw', draw);
    $('#clearCanvas').click(function(){
			socket.emit('clearCanvas');
    });
    socket.on('clearCanvas', function(){
      console.log("clicked")
      context.clearRect(0,0, canvas.width(), canvas.height());
    })
	  function draw(line) {
		  context.lineJoin = 'round';
		  context.lineWidth = line.lineWidth
		  context.strokeStyle = line.color
		  context.beginPath();
		
		  if(line.from) {
			  context.moveTo(line.from.x, line.from.y);
		  }else{
			  context.moveTo(line.to.x-1, line.to.y);
		  }
		
		  context.lineTo(line.to.x, line.to.y);
		  context.closePath();
		  context.stroke();
		  
	    }
    canvas.mouseout(function(e) {
	    status = false;
	  });
	
	  canvas.mouseup(function(e) {
  		status = false;
    });
    canvas.mousedown(function(e) {
  		if(myturn) {
  			status = true;
  			var newpoint = { x: e.pageX - this.offsetLeft, y: e.pageY - this.offsetTop},
  				line = { from: null, to: newpoint, color: $("#favcolor").val(), lineWidth: $('#favsize').val()};
  			
  			draw(line);
  			lastpoint = newpoint;
  			socket.emit('draw', line);
  	  }
	  });
	
	  canvas.mousemove(function(e) {
  		if(myturn && status) {
  			var newpoint = { x: e.pageX - this.offsetLeft, y: e.pageY - this.offsetTop},
  				line = { from: lastpoint, to: newpoint, color: $("#favcolor").val(), lineWidth: $('#favsize').val()};
  			
  			draw(line);
  			lastpoint = newpoint;
  			socket.emit('draw', line);
  		} 
  	});
  	
	  
  });
</script>
  <body>
    <div id = "container">
  			<div id="drawpanel">
  			  <div id= "wordbox"></div>
  				<canvas id="canvas" width="750" height="750"></canvas>
  			</div>
  			  <div id="chatpanel">
    			  <div id="chatcontent">
    			    <center><h>Chat:</h></center>
    			  </div>
    			  <div id = "chatcontrol">
              <input id="m" autocomplete="off" style="font-size:16pt; width:98%"/>
    			  </div>
  			</div>
  			<div id = "users">
  		    <div id = "drawcontrol">
  		      <input type = "button" id ="clearCanvas" value = "Clear" />
            <input type="color" id="favcolor" value="#000000">
            <br/>
            <p1>Brush Size:</p1>
            <input type="range" id="favsize" min = "1" max = "50" value = "5">
  		    </div>
  				  
  			</div>
			</div>
  </body>
</html>